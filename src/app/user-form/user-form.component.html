<form (submit)="save()" class="form sign-in-form" [formGroup]="userForm">

    <div *ngIf="showSuccess" class="form-group alert alert-success success-message mb-3">
        Saved successfully.
    </div>

    <div *ngIf="errorMessage" class="form-group alert alert-danger error-message mb-3">
        {{ errorMessage }}
    </div>

    <div class="form-group">
        <label for="userEmail">Email</label>
        <input formControlName="UserEmail" id="userEmail" maxlength="128" [email]="true"
               class="form-control" required type="email" name="email"
               *ngIf="authService.user.role === 'administrator'; else showEmail"
               [class.is-invalid]="userForm.controls.UserEmail.touched && userForm.controls.UserEmail.invalid">

        <ng-template #showEmail>
            <div class="mt-1">
                <i>{{ user.email }}</i>
            </div>
        </ng-template>
    </div>

    <div class="form-group">
        <label for="firstName" class="mt-3">First Name</label>
        <input formControlName="FirstName" id="firstName" minlength="1" maxlength="128"
               class="form-control" required name="firstName"
               pattern="[a-zA-Z ]*"
               [class.is-invalid]="userForm.controls.FirstName.touched && userForm.controls.FirstName.invalid">
    </div>

    <div class="form-group">
        <label for="lastName" class="mt-3">Last Name</label>
        <input formControlName="LastName" id="lastName" minlength="1" maxlength="128"
               class="form-control" required name="lastName"
               pattern="[a-zA-Z ]*"
               [class.is-invalid]="userForm.controls.LastName.touched && userForm.controls.LastName.invalid">
    </div>

    <div class="form-group">
        <label for="role" class="mt-3">Role</label>
        <select formControlName="Role" id="role" *ngIf="user.id !== authService.user.id; else showRole"
               class="form-control" required name="role"
               [class.is-invalid]="userForm.controls.Role.touched && userForm.controls.Role.invalid">
            <option *ngFor="let role of roles" [value]="role">{{ role }}</option>
        </select>
        <ng-template #showRole>
            <div class="mt-1">
                <i>{{ user.role }}</i>
            </div>
        </ng-template>
    </div>

    <div class="form-group">
        <div *ngIf="setPassword; else setPasswordButton">
            <label for="userPassword" class="mt-3">Password <small>(12 characters min.)</small></label>
            <input formControlName="UserPassword" id="userPassword" minlength="12" maxlength="128"
                   class="form-control" type="password" name="password" autocomplete="new-password"
                   [class.is-invalid]="userForm.controls.UserPassword.touched && userForm.controls.UserPassword.invalid">
        </div>
        <ng-template #setPasswordButton>
            <button class="btn btn-secondary mt-4 mb-3" (click)="setPassword = true">Set New Password</button>
        </ng-template>
    </div>

    <div class="form-group" *ngIf="user.id === authService.user.id; else disable2fa">
        <label for="FA" class="mt-3">
            <input formControlName="FA" id="FA" type="checkbox" name="FA" (change)="generate2fa()">
            2FA Enabled
        </label>

        <div *ngIf="twoFactor" class="mt-2 p-4">
            Write down your 2FA secret code:
            <div class="alert alert-warning text-center mt-2 mb-4">
                {{ twoFactor.secret }}
            </div>

            Scan the QR code with your Authenticator app:
            <qrcode [qrdata]="twoFactor.uri" [width]="256" [errorCorrectionLevel]="'M'"></qrcode>
        </div>
    </div>

    <ng-template #disable2fa>
        <div class="form-group" *ngIf="user.id && fa && fa.value">
            <label for="Disable2FA" class="mt-3">
                <input formControlName="Disable2FA" id="Disable2FA" type="checkbox" name="Disable2FA">
                Disable 2FA
            </label>
        </div>
    </ng-template>

    <div class="form-group" *ngIf="user.id !== authService.user.id && user.id">
        <label for="activeUser" class="mt-3">
            <input formControlName="Active" id="activeUser" type="checkbox" name="activeUser">
            Active
        </label>
    </div>

    <div class="form-group mt-3">
        <button class="form-control btn-success"
                [class.btn-warning]="userForm.invalid"
                [disabled]="userForm.invalid"
                type="submit">Save Changes</button>
    </div>
</form>
