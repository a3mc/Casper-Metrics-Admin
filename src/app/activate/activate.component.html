<div class="alert alert-danger" *ngIf="denyError; else signForm">
    Something went wrong. Contact your administrator.
</div>
<ng-template #signForm>
    <form (submit)="save()" class="form activate-form" [formGroup]="userForm" *ngIf="userForm">

        <h4>Please complete the form to activate your account</h4>

        <div *ngIf="errorMessage" class="form-group alert alert-danger error-message mb-3">
            {{ errorMessage }}
        </div>

        <div class="form-group mt-4">
            <div>
                {{ user.firstName }} {{ user.lastName }}
            </div>
            <i>{{ user.email }}</i>
        </div>

        <div class="form-group">
            <label for="userPassword" class="mt-3">
                Password <small class="text-muted">(12 chars min.)</small>
            </label>
            <input formControlName="UserPassword" id="userPassword" minlength="12" maxlength="128" autofocus
                   class="form-control" required type="password" name="password" autocomplete="new-password"
                   [class.is-invalid]="userForm.controls.UserPassword.touched && userForm.controls.UserPassword.invalid">
        </div>

        <div class="form-group">
            <label for="userPassword" class="mt-3">Repeat Password</label>
            <input formControlName="UserPassword2" id="userPassword2" minlength="12" maxlength="128"
                   class="form-control" required type="password" name="password2" autocomplete="new-password"
                   [class.is-invalid]="userForm.controls.UserPassword2.touched && userForm.controls.UserPassword2.invalid">
        </div>

        <div *ngIf="twoFactor" class="form-group mt-2 p-4">
            1. Write down your 2FA secret code:
            <div class="alert alert-warning text-center mt-2 mb-4">
                {{ twoFactor.secret }}
            </div>

            <div class="mb-2">2. Scan the QR code with your Authenticator app:</div>
            <qrcode [qrdata]="twoFactor.uri" [width]="256" [errorCorrectionLevel]="'M'"></qrcode>

            <div class="mt-3">
                <label for="verifyCode" class="mb-2">
                    3. Enter the code from your Authenticator app:
                </label>
                <input minlength="6" maxlength="6" size="6" name="verifyCode" id="verifyCode" required
                       [class.is-invalid]="userForm.controls.VerificationCode.touched &&
                            userForm.controls.VerificationCode.invalid"
                       pattern="[0-9]+" [disabled]="twoFactorVerified"
                       formControlName="VerificationCode" class="form-control ms-4">

                <button class="btn btn-small btn-primary btn-success ms-2"
                        [disabled]="verificationCode.invalid || twoFactorVerified"
                        type="button" (click)="verifyCode()">
                    Verify
                </button>

                <i class="fa fa-check text-success ms-3" *ngIf="twoFactorVerified"></i>
                <i class="fa fa-exclamation text-danger ms-3" *ngIf="twoFactorWrong"></i>
            </div>
        </div>

        <div class="form-group mt-3">
            <button [class.disabled]="userForm.invalid || !twoFactorVerified"
                    [disabled]="userForm.invalid || !twoFactorVerified"
                    class="form-control btn-success sign-btn"
                    type="submit">Submit
            </button>
        </div>
    </form>


</ng-template>
